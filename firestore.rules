rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isSuperAdmin() {
      return isAuthenticated() && getUserData().role == 'Super Admin';
    }

    function isAdmin() {
      return isAuthenticated() && getUserData().role in ['Admin', 'Super Admin'];
    }
    
    function isService() {
      return isAuthenticated() && getUserData().role == 'Service';
    }
    
    function isDemoManager() {
       return isAuthenticated() && getUserData().role == 'DemoManager';
    }
    
    function isStoreManager() {
       return isAuthenticated() && getUserData().role == 'Store Manager';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- Collection Rules ---

    // USERS COLLECTION
    match /users/{userId} {
      allow list, read: if isAdmin();
      allow update: if isOwner(userId) || isSuperAdmin();
      allow create: if isOwner(userId);
      allow delete: if isSuperAdmin();
    }
    
    // SETTINGS & COUNTERS
    match /company_profile/{docId} {
        allow read: if isAuthenticated();
        allow write: if isSuperAdmin();
    }
    match /financial_settings/{docId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    match /counters/{docId} {
      allow read, write: if isAuthenticated(); 
    }

    // CORE MODULES - Admins have full access, other roles get read access for dropdowns
    match /lc_entries/{docId=**} { 
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    match /proforma_invoices/{docId=**} { 
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    match /customers/{docId=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isStoreManager();
    }
    match /suppliers/{docId=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isStoreManager();
    }

    // FINANCIAL MANAGEMENT
    match /quotes/{docId=**} { allow read, write: if isAdmin() || isStoreManager(); }
    match /invoices/{docId=**} { allow read, write: if isAdmin() || isStoreManager(); }
    match /orders/{docId=**} { allow read, write: if isAdmin() || isStoreManager(); }
    match /payments/{docId=**} { allow read, write: if isAdmin() || isStoreManager(); }
    
    // INVENTORY MANAGEMENT
    match /items/{docId=**} { allow read, write: if isAdmin() || isStoreManager(); }
    match /sales/{docId=**} { allow read, write: if isAdmin() || isStoreManager(); }

    // DEMO M/C MANAGEMENT
    match /demo_machine_factories/{docId=**} { allow read, write: if isAdmin() || isDemoManager(); }
    match /demo_machines/{docId=**} { allow read, write: if isAdmin() || isDemoManager(); }
    match /demo_machine_applications/{docId=**} { allow read, write: if isAdmin() || isDemoManager(); }
    
    // WARRANTY MANAGEMENT
    match /installation_reports/{docId=**} { allow read, write: if isAdmin() || isService(); }
  }
}
