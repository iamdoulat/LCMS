rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /hotspots/{hotspotId} {
      allow read, write: if request.auth != null;
    }
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check user roles (handles both array and string formats)
    function hasRole(role) {
      return isAuthenticated() && (
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role is list && role in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role) ||
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role is string && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role)
      );
    }
    
    // Helper function to check if user has any of the specified roles
    function hasAnyRole(roles) {
      return isAuthenticated() && (
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role is list && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role.hasAny(roles)) ||
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role is string && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in roles)
      );
    }
    
    // Helper function to check multiple roles
    function isOneOfRoles(roles) {
      return hasAnyRole(roles);
    }
    
    // Helper function to check if user is Admin or Super Admin
    function isAdmin() {
      return hasAnyRole(['Super Admin', 'Admin']);
    }
    
    // --- COLLECTION RULES ---
    
    // NOTE: 'User' and 'Employee' roles primarily rely on isAuthenticated() checks 
    // for reading/writing their own data, unless otherwise specified.

    // Users collection
    match /whatsapp_gateways/{document} {
      allow read, write: if request.auth != null;
    }

    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      request.resource.data.uid == userId &&
                      request.resource.data.email == request.auth.token.email;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isAdmin();
      allow update: if isAdmin();
      allow delete: if hasRole('Super Admin');
    }

    // Employees collection
    match /employees/{employeeId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      allow read: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid == employeeId || 
        request.auth.token.email == resource.data.email ||
        request.auth.uid == (resource.data.uid)
      ) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['photoURL', 'updatedAt']);
    }

    // Check-in/Check-out collection
    match /checkInOut/{recordId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Attendance collection
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated();
      allow create: if isOneOfRoles(['Super Admin', 'Admin', 'HR']) || (isAuthenticated() && request.resource.data.employeeId == request.auth.uid);
      allow update: if isOneOfRoles(['Super Admin', 'Admin', 'HR']) || (isAuthenticated() && resource.data.employeeId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // Attendance Reconciliation collection
    match /attendance_reconciliation/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        isOneOfRoles(['Super Admin', 'Admin', 'HR', 'Employee']) || 
        request.resource.data.employeeId == request.auth.uid
      );
      allow update: if isOneOfRoles(['Super Admin', 'Admin', 'HR']) || (
        isAuthenticated() && resource.data.employeeId == request.auth.uid
      );
      allow delete: if isOneOfRoles(['Super Admin', 'Admin','HR']);
    }

    // Financial settings
    match /financial_settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Counters
    match /counters/{counter} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // LCs (Letter of Credit)
    match /lcs/{lcId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // PIs (Proforma Invoice)
    match /pis/{piId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Quotations
    match /quotations/{quotationId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Customers (Applicants/Buyers)
    match /customers/{customerId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts', 'Service', 'DemoManager']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Suppliers (Beneficiaries)
    match /suppliers/{supplierId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts', 'Service', 'DemoManager']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // LC Entries
    match /lc_entries/{lcEntryId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Demo Machines
    match /demo_machines/{machineId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'DemoManager', 'Service']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Demo Machine Factories
    match /demo_machine_factories/{factoryId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'DemoManager', 'Service']);
    }

    // Demo Machine Applications
    match /demo_machine_applications/{appId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'DemoManager', 'Service']);
    }

    // Demo Machine Challans
    match /demo_machine_challans/{challanId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'DemoManager', 'Service']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Proforma Invoices
    match /proforma_invoices/{piId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Items/Products
    match /items/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Quote Items
    match /quote_items/{quoteItemId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Installation Reports
    match /installation_reports/{reportId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Service', 'Viewer']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Service']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Claim Reports
    match /claim_reports/{reportId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Service', 'Viewer']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Service']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Deferred Payment Tracker
    match /deferred_payment_tracker/{trackerId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Accounts', 'Commercial']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Accounts']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Advance Salary
    match /advance_salary/{salaryId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'HR', 'Accounts', 'Employee']) || (isAuthenticated() && resource.data.employeeId == request.auth.uid);
      allow create: if isOneOfRoles(['Super Admin', 'Admin', 'HR', 'Employee']) || (isAuthenticated() && request.resource.data.employeeId == request.auth.uid);
      allow update: if isOneOfRoles(['Super Admin', 'Admin', 'HR']) || (isAuthenticated() && resource.data.employeeId == request.auth.uid && resource.data.status == 'Pending');
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Employee-related collections
    match /designations/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }
    
    match /branches/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }
    
    match /hotspots/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }
    
    match /departments/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }
    
    match /units/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }
    
    match /divisions/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Multiple check in/out (new system)
    match /multiple_check_inout/{recordId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        isOneOfRoles(['Super Admin', 'Admin', 'HR', 'Employee']) || 
        request.auth.uid == request.resource.data.employeeId
      );
      allow update: if isOneOfRoles(['Super Admin', 'Admin', 'HR']) || (
        isAuthenticated() && request.auth.uid == resource.data.employeeId
      );
      allow delete: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Allow all other common collections with basic auth
    match /item_categories/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Accounts']);
    }
    
    match /currencies/{currencyId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin']);
    }
    
    match /item_sections/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Accounts']);
    }
    
    match /item_variations/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Accounts']);
    }

    // Warehouses
    match /warehouses/{warehouseId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Accounts']);
    }

    // Quotes (Sales Quotes)
    match /quotes/{quoteId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Invoices (Sales Invoices)
    match /invoices/{invoiceId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Accounts']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Purchase Orders
    match /purchase_orders/{orderId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Proforma Invoice Layout Settings
    match /pi_layout_settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
    }

    // Delivery Challans
    match /delivery_challans/{challanId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts', 'Service', 'DemoManager']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Service']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Inventory Orders
    match /inventory_orders/{orderId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Payments
    match /payments/{paymentId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Accounts', 'Viewer']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Accounts']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Proforma Invoice Settings
    match /pi_settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
    }

    // Notice board
    match /notices/{noticeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      allow delete: if isAdmin();
    }

    // Sales Invoice
    match /sales_invoice/{invoiceId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Accounts']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Petty Cash Accounts
    match /petty_cash_accounts/{accountId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Accounts']);
    }

    // Petty Cash Transactions
    match /petty_cash_transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Accounts']);
    }

    // Petty Cash Categories
    match /petty_cash_categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Accounts']);
    }

    // Payrolls
    match /payrolls/{payrollId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'HR', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Payslips
    match /payslips/{payslipId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Holidays
    match /holidays/{holidayId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Leave Applications
    match /leave_applications/{leaveId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        isOneOfRoles(['Super Admin', 'Admin', 'HR', 'Employee']) || 
        request.resource.data.employeeId == request.auth.uid
      );
      allow update: if isOneOfRoles(['Super Admin', 'Admin', 'HR']) || (
        isAuthenticated() && resource.data.employeeId == request.auth.uid
      );
      allow delete: if isAdmin();
    }

    // HRM Settings
    match /hrm_settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    match /hrm_settings/leave_types/items/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    match /hrm_settings/leave_groups/items/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Site Settings
    match /site_settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Visit Applications
    match /visit_applications/{visitId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        isOneOfRoles(['Super Admin', 'Admin', 'HR', 'Employee']) || 
        request.resource.data.employeeId == request.auth.uid
      );
      allow update: if isOneOfRoles(['Super Admin', 'Admin', 'HR']) || (
        isAuthenticated() && resource.data.employeeId == request.auth.uid
      );
      allow delete: if isAdmin();
    }

    // SMTP Settings
    match /smtp_settings/{settingId} {
      allow read, write: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Telegram Bot Settings
    match /telegram_settings/{settingId} {
      allow read, write: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Telegram Templates
    match /telegram_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Email Templates
    match /email_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // WhatsApp Templates
    match /whatsapp_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // System Logs
    match /system_logs/{logId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin']); 
      allow write: if isAuthenticated();
    }
        // Device Change Requests - Allow users to request access, Admins/HR to manage
    match /device_change_requests/{requestId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'HR']) || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Break Time collection
    match /break_time/{recordId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }


    // System settings - global app configuration
    match /system_settings/{document} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isOneOfRoles(['Super Admin', 'Admin', 'HR'])
      );
    }    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
