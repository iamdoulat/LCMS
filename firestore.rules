rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isSuperAdmin() {
      return isAuthenticated() && getUserData().role == 'Super Admin';
    }

    function isAdmin() {
      return isAuthenticated() && getUserData().role in ['Admin', 'Super Admin'];
    }
    
    function isService() {
      return isAuthenticated() && getUserData().role == 'Service';
    }
    
    function isDemoManager() {
       return isAuthenticated() && getUserData().role == 'DemoManager';
    }
    
    function isStoreManager() {
       return isAuthenticated() && getUserData().role == 'Store Manager';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- Collection Rules ---

    // Users Collection
    match /users/{userId} {
      allow list, read: if isAdmin();
      allow update: if isOwner(userId) || isSuperAdmin();
      allow create, delete: if isSuperAdmin();
    }
    
    // Settings Collections (Only Super Admin)
    match /company_profile/{docId} {
      allow read: if isAuthenticated(); // All users can read company info
      allow write: if isSuperAdmin();
    }
     match /counters/{docId} {
      allow read, write: if isAuthenticated();
    }

    // Core Modules (Admin & Super Admin)
    match /lc_entries/{docId=**} { allow read, write: if isAdmin(); }
    match /proforma_invoices/{docId=**} { allow read, write: if isAdmin(); }

    // Financial Management (Admin & Super Admin)
    match /quotes/{docId=**} { allow read, write: if isAdmin(); }
    match /invoices/{docId=**} { allow read, write: if isAdmin(); }
    match /orders/{docId=**} { allow read, write: if isAdmin(); }
    match /payments/{docId=**} { allow read, write: if isAdmin(); }
    
    // Inventory Management (Admin, Super Admin, Store Manager)
    match /items/{docId=**} { allow read, write: if isAdmin() || isStoreManager(); }
    match /sales/{docId=**} { allow read, write: if isAdmin() || isStoreManager(); }

    // General Management (Admin & Super Admin)
    match /customers/{docId=**} { allow read, write: if isAdmin(); }
    match /suppliers/{docId=**} { allow read, write: if isAdmin(); }

    // Demo M/C Management (Admin, Super Admin, DemoManager)
    match /demo_machine_factories/{docId=**} { allow read, write: if isAdmin() || isDemoManager(); }
    match /demo_machines/{docId=**} { allow read, write: if isAdmin() || isDemoManager(); }
    match /demo_machine_applications/{docId=**} { allow read, write: if isAdmin() || isDemoManager(); }
    
    // Warranty Management (Admin, Super Admin, Service)
    match /installation_reports/{docId=**} { allow read, write: if isAdmin() || isService(); }
  }
}