rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check user roles
    function hasRole(role) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role is list &&
             role in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user has any of the specified roles
    function hasAnyRole(roles) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role is list &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role.hasAny(roles);
    }
    
    // Helper function to check multiple roles
    function isOneOfRoles(roles) {
      return hasAnyRole(roles);
    }
    
    // Helper function to check if user is Admin or Super Admin
    function isAdmin() {
      return hasAnyRole(['Super Admin', 'Admin']);
    }

    // --- COLLECTION RULES ---

    // Users collection
    match /users/{userId} {
      // Allow user to read their own document
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow authenticated users to create their own user document during registration
      allow create: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      request.resource.data.uid == userId &&
                      request.resource.data.email == request.auth.token.email;
      
      // Allow user to update their own document
      allow update: if isAuthenticated() && request.auth.uid == userId;
      
      // Admins can read all users
      allow read: if isAdmin();
      
      // Admins can update any user
      allow update: if isAdmin();
      
      // Super Admin can delete users
      allow delete: if hasRole('Super Admin');
    }

    // Employees collection
    match /employees/{employeeId} {
      // Allow admins/HR to manage employees
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      // Allow authenticated employees to read their own employee data
      allow read: if isAuthenticated();
    }

    // Check-in/Check-out collection
    match /checkInOut/{recordId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Attendance collection
    match /attendance/{attendanceId} {
      // Allow admins/HR to manage attendance
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      // Allow authenticated employees to read their own attendance (attendanceId format: employeeId_date)
      allow read: if isAuthenticated();
    }

    // Attendance Reconciliation collection
    match /attendance_reconciliation/{requestId} {
      // Allow employees to read their own reconciliations
      allow read: if isAuthenticated();
      // Allow employees to create reconciliation requests
      allow create: if isAuthenticated();
      // Allow admins/HR to update (approve/reject) reconciliations
      allow update: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      // Allow admins to delete reconciliations
      allow delete: if isOneOfRoles(['Super Admin', 'Admin','HR']);
    }

    // Financial settings
    match /financial_settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Counters
    match /counters/{counter} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // LCs (Letter of Credit)
    match /lcs/{lcId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // PIs (Proforma Invoice)
    match /pis/{piId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Quotations
    match /quotations/{quotationId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Customers (Applicants/Buyers)
    match /customers/{customerId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts', 'Service', 'DemoManager']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Suppliers (Beneficiaries)
    match /suppliers/{supplierId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts', 'Service', 'DemoManager']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // LC Entries (actual collection name used in code)
    match /lc_entries/{lcEntryId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Demo Machines
    match /demo_machines/{machineId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'DemoManager', 'Service']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Demo Machine Factories
    match /demo_machine_factories/{factoryId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'DemoManager', 'Service']);
    }

    // Demo Machine Applications
    match /demo_machine_applications/{appId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'DemoManager', 'Service']);
    }

    // Proforma Invoices
    match /proforma_invoices/{piId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Items/Products
    match /items/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Quote Items
    match /quote_items/{quoteItemId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Installation Reports
    match /installation_reports/{reportId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Service', 'Viewer']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Service']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Claim Reports
    match /claim_reports/{reportId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Service', 'Viewer']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Service']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Deferred Payment Tracker
    match /deferred_payment_tracker/{trackerId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Accounts', 'Commercial']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Accounts']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Advance Salary
    match /advance_salary/{salaryId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'HR', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Employee-related collections (Designations, Branches, Departments, Units, Divisions)
    match /designations/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }
    
    match /branches/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }
    
    match /departments/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }
    
    match /units/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }
    
    match /divisions/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Multiple check in/out (new system)
    match /multiple_check_inout/{recordId} {
      allow read: if isAuthenticated();
      // Allow any authenticated user to create check-in/out records
      // (employeeId in document is Firestore doc ID, not Firebase Auth UID)
      allow create: if isAuthenticated();
      allow update: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Allow all other common collections with basic auth
    match /item_categories/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin']);
    }
    
    match /item_sections/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin']);
    }
    
    match /item_variations/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Quotes (Sales Quotes)
    match /quotes/{quoteId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Invoices (Sales Invoices)
    match /invoices/{invoiceId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Accounts']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Purchase Orders
    match /purchase_orders/{orderId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // PI Settings (Proforma Invoice Settings)
    match /pi_layout_settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial']);
    }

    // Notice board
    match /notices/{noticeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      allow delete: if isAdmin();
    }

    // Sales Invoice
    match /sales_invoice/{invoiceId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Viewer', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Commercial', 'Accounts']);
      allow delete: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Petty Cash Accounts
    match /petty_cash_accounts/{accountId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Accounts']);
    }

    // Petty Cash Transactions
    match /petty_cash_transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'Accounts']);
    }

    // Payrolls
    match /payrolls/{payrollId} {
      allow read: if isOneOfRoles(['Super Admin', 'Admin', 'HR', 'Accounts']);
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Payslips
    match /payslips/{payslipId} {
      allow read: if isAuthenticated(); // Employees can read their own (handled by query filters usually) or refined here
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Holidays
    match /holidays/{holidayId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Leave Applications
    match /leave_applications/{leaveId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Employees apply, HR approves
    }

    // HRM Settings
    match /hrm_settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isOneOfRoles(['Super Admin', 'Admin', 'HR']);
    }

    // Site Settings (including notices)
    match /site_settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Visit Applications
    match /visit_applications/{visitId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Employees apply, HR approves
    }

    // SMTP Settings (Admin Only - Sensitive Info)
    match /smtp_settings/{settingId} {
      allow read, write: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Email Templates
    match /email_templates/{templateId} {
      allow read: if isAuthenticated(); // Users might need to trigger emails? Or just Server?
      // For now, let's restrict write to Admins
      allow write: if isOneOfRoles(['Super Admin', 'Admin']);
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
